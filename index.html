<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>40k Tracker</title>
    
    <script type="application/javascript" src="https://unpkg.com/mithril/mithril.js"></script>
    <script type="application/javascript" src="data.js"></script>
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch&family=Iceland&display=swap"
          rel="stylesheet">
  </head>
  
  <body>
    <div id="army">
      <div id="armyName">
        Aeldari
      </div>
      <div id="army-image">
        <img src="img/aeldari.png">
      </div>
    </div>
    <div id="victory-points">
      <p>VP</p>
      <div id="command-points">
      </div>
    </div>
    <div id="turnList">
    </div>
    
    <script type="text/javascript">

      let turnData = [
        { turnNumber:4, missions: [{ name: 'primary', score: 2 },
                                   { name: 'Establish Locus', score: 3 },
                                   { name: 'Storm Hostile Objective', score: 4 }] },
        { turnNumber:3, missions: [{ name: 'primary', score: 0 },
                                   { name: 'Establish Locus', score: 2 },
                                   { name: 'Storm Hostile Objective', score: 1 }] },
        { turnNumber:2, missions: [{ name: 'primary', score: 2 },
                                   { name: 'Establish Locus', score: 4 },
                                   { name: 'Storm Hostile Objective', score: 6 }] },
        { turnNumber:1, missions: [{ name: 'primary', score: 3 },
                                   { name: 'Establish Locus', score: 0 },
                                   { name: 'Storm Hostile Objective', score: 11 }]
        },
      ];

      // pull out every mission from every turn, flatten the list, extract the scores, and sum them all up
      const calcVP = (turnData)=>turnData.map((t)=>t.missions).flat().map((m)=>m.score).reduce((a,c)=>a+c)

      const armySelect = (vnode) => {
        let army = (vnode.attrs.army || {name: ''})
        return {
          view: () => [
            m('select.armySelect',
              {
                onchange: e => army.name = e.target.value,
                value: army.name,
                name: 'army',
                required: true,
              },
              m('option', {value:'',disabled: 'true', hidden:'true'}, 'choose your army'),
              armyList.map(x => m('option', x)),
             )
          ]
        }
      }

      const armySection = (vnode) => {
        let army = (vnode.attrs.army || {name: ''})
        return {
          view: () => [
            m('div#armyName',[
              m(armySelect, {army:army})
            ]),
            m('div#armyImage', [
              m('img', {src: `img/${(army.name || 'no-army' ).toLowerCase()}.png`})
            ])
            // <div id="armyName">
            //   Aeldari
            // </div>
            // <div id="army-image">
            //   <img src="img/aeldari.png">
            // </div>
            
          ]
        }
      }
      
      const missionSelect = (vnode) => {
        let mission = (vnode.attrs.mission || {name: ''})
        return {
          view: () => [
            m('select.missionSelect',
              {
                onchange: e => mission.name = e.target.value,
                value: mission.name,
                name: 'mission',
                required: true,
              },
              m('option', {value:'',disabled: 'true', hidden:'true'}, 'choose mission'),
              missionList.map(x => m('option', x)),
             )
          ]
        }
      }

      const turnMissionSection = (vnode) => {
        let missionData = (vnode.attrs.missions || [
          { name: 'primary', score: 0 },
          { name: '', score: 0 },
          { name: '', score: 0 },
        ] )
        
        return {
          view: () => [
            missionData.map(mission => (
              m('div.mission', [
                (mission.name=='primary') ? 'Primary' : m(missionSelect, {mission:mission}),
                m('input.score',
                  {
                    onclick: () => { mission.score++ },
                    oninput: (e) => { mission.score = e.target.value },
                    value: mission.score,
                  })
              ]
               )))
          ]
        }
      }

      const turnSection = (vnode) => {
        let turnData = (vnode.attrs.turns || [
          { turnNumber:1, missions: [{ name: 'primary', score: 0 },
                                     { name: '', score: 0 },
                                     { name: '', score: 0 }]
          }
        ])
        
        return {
          view: () => [
            turnData.map(turn => (
              m('div.turn',
                [
                  m('p.turnNumber', `Turn ${turn.turnNumber}`),
                  m(turnMissionSection, {missions: turn.missions})
                ]
               ))
             )
          ]
        }
      }

      
      const turnListElement = document.getElementById('turnList');
      const testElement = document.getElementById('test');
      const armyElement = document.getElementById('army');

      let armyData = {name:''}

      m.mount(armyElement, { view: () => m(armySection, { army: armyData }) })

      let component = { view: () => m(turnSection, { turns: turnData }) }
      //let component = { view: () => m(turnSection) }
      
      m.mount(turnListElement, component)
      
    </script>
  </body>
</html>
